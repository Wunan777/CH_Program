<!DOCTYPE html>
<html lang="en">
<head>
	<meta charset="UTF-8">
	<title>Interrupt</title>
  <link rel="stylesheet" type="text/css" href="css/index.css">
</head>
<body>

<div id="content">

<div class="TEC" id="TEC1">
   	<div class="console" id="console1">
		<p>TEC-XP Simulation Program</p>
		<p>Version 2.0 2016.3.28</p>
		<p>Computer Architectur DUT</p>
    <p>> </p>
	  </div>
 	  
    <div id="control_div">
		  <div id="button_area">
		 	 <div id="Reset" class="button">Reset</div>
		 	 <div id="Start" class="button">Start</div>
		 	 <div id="btn1" class="button">Button1</div>
		 	 <div id="btn2" class="button">Button2</div>
		 	 <div id="btn3" class="button">Button3</div>
		  </div>
		  <div class="register" id="register1">
		 	 <dl>
		 	 	<dd><p>R0<span  class="R0">0000</span></p></dd>
		 	 	<dd><p>R1<span  class="R1">0000</span></p></dd>
		 	 	<dd><p>R2<span  class="R2">0000</span></p></dd>
		 	 	<dd><p>R3<span  class="R3">0000</span></p></dd>
		 	 	<dd><p>SP<span  class="SP">0000</span></p></dd>
		 	 	<dd><p>PC<span  class="PC">0000</span></p></dd>
		 	 	<dd><p>R6<span  class="R6">0000</span></p></dd>
		 	 	<dd><p>R7<span  class="R7">0000</span></p></dd>
        <dd><p>R8<span  class="R8">0000</span></p></dd>
        <dd><p>R9<span  class="R9">0000</span></p></dd>
        <dd><p>R10<span class="R10">0000</span></p></dd>
        <dd><p>R11<span class="R11">0000</span></p></dd>
        <dd><p>R12<span class="R12">0000</span></p></dd>
        <dd><p>R13<span class="R13">0000</span></p></dd>
        <dd><p>R14<span class="R14">0000</span></p></dd>
        <dd><p>R15<span class="R15">0000</span></p></dd>
		 	 </dl>
		  </div>
	  </div>
</div>

<div class="TEC" id="TEC2">
    <div class="console" id="console2">
    <p>TEC-XP Simulation Program</p>
    <p>Version 2.0 2016.3.28</p>
    <p>Computer Architectur DUT</p>
    <p>> </p>
    </div>
    
    <div id="control_div">
      <div id="button_area">
       <div id="Reset" class="button">Reset</div>
       <div id="Start" class="button">Start</div>
       <div id="btn1" class="button">Button1</div>
       <div id="btn2" class="button">Button2</div>
       <div id="btn3" class="button">Button3</div>
      </div>
      <div class="register" id="register2">
       <dl>
        <dd><p>R0<span id="R0">0000</span></p></dd>
        <dd><p>R1<span id="R1">0000</span></p></dd>
        <dd><p>R2<span id="R2">0000</span></p></dd>
        <dd><p>R3<span id="R3">0000</span></p></dd>
        <dd><p>SP<span id="SP">0000</span></p></dd>
        <dd><p>PC<span id="PC">0000</span></p></dd>
        <dd><p>R6<span id="R6">0000</span></p></dd>
        <dd><p>R7<span id="R7">0000</span></p></dd>
        <dd><p>R8<span id="R8">0000</span></p></dd>
        <dd><p>R9<span id="R9">0000</span></p></dd>
        <dd><p>R10<span id="R10">0000</span></p></dd>
        <dd><p>R11<span id="R11">0000</span></p></dd>
        <dd><p>R12<span id="R12">0000</span></p></dd>
        <dd><p>R13<span id="R13">0000</span></p></dd>
        <dd><p>R14<span id="R14">0000</span></p></dd>
        <dd><p>R15<span id="R15">0000</span></p></dd>
       </dl>
      </div>
    </div>
</div>

<!-- content end -->
</div> 
</body>
<script type="text/javascript" src="js/Tool.js"></script>
<script type="text/javascript" src="js/Parse_Init_Order.js"></script>
<script type="text/javascript" src="js/Parse_A_Line.js"></script>
<script type="text/javascript" src="js/Parse_E_Line.js"></script>
<script type="text/javascript" src="js/U_Show.js"></script>
<script type="text/javascript" src="js/G_Run.js"></script>
<script type="text/javascript" src="js/Fn.js"></script>
<script type="text/javascript" src="js/Draw_Line.js"></script>
    
<script type="text/javascript">
    


     var table = [
                 "ADD 00 R_2", 
                 "SUB 01 R_2",
                 "AND 02 R_2",
                 "CMP 03 R_2",
                 "XOR 04 R_2",
                 "TEST 05 R_2",
                 "OR 06 R_2",
                 "MVRR 07 R_2",
                 "DEC 08 R_1",
                 "INC 09 R_1",
                 "SHL 0A R_1",
                 "SHR 0B R_1",
                 "JR 41 OFFSET",
                 "JRC 44 OFFSET",
                 "JRNC 45 OFFSET",
                 "JRZ 46 OFFSET",
                 "JRNZ 47 OFFSET",
                 "JMPA 80 OFFSET",
                 "IN 82 PORT",
                 "PUSH 85 R_1",
                 "OUT 86 PORT",
                 "POP 87 R_1",
                 "MVRD 88 R_1",
                 "CALA CE OFFSET",
                 "EI 6E NONE",
                 "DI 6F NONE",
                 "RET 8F NONE",
                 "IRET EF NONE"
                 ];
     var PORT = {"80":"0000","81":"0000"};
     var init_line_len = 5; //&gt\b A 2000 >和空格
     var command_line_len = 7; // A 2000 :
     
     var TEC1 = {};
     var TEC2 = {};


   
     // var FLAG = 1;  // 默认是开中断的
     // var Level = 0;
     // var Level_Change = 0;
    window.onload = function()
    {  
      
       //当前正在编辑行
       // 五种类型参数 R_0,R_1,OFFSET,PORT,MVRD_NEXT
        Init();
    }///window end

    function Init()
    { 
      // var Start = document.getElementById('Start');
      // var Button1 = document.getElementById('btn1');
      // var Button2 = document.getElementById('btn2');
      // var Button3 = document.getElementById('btn3');

      // // Start.addEventListener("click",Init);
      // Button1.addEventListener("click",Jump1);
      // Button2.addEventListener("click",Jump2);
      // Button3.addEventListener("click",Jump3);
      Tec_Init(TEC1,"TEC1",1);
      Tec_Init(TEC2,"TEC2",2);
      var T1 = document.getElementById("TEC1");
      var T2 = document.getElementById("TEC2");
      EventUtil.addHandler(T1,"mouseover",function(){
        TEC1.screen = 1;
        TEC2.screen = 0;
      });
      EventUtil.addHandler(T2,"mouseover",function(){
        TEC2.screen = 1;
        TEC1.screen = 0;
      });
      document.onkeydown = keyDown;
      
    }
    
    function Tec_Init(obj,name,num)
    {
         // 初始状态 分为3个状态 其余两个为 
         //1 : A   2 : E  
         //3 : G   4 : U
         obj.name = name;
         obj.num = num;
         obj.memory = [];
         obj.PC = 0;      // 10进制
         obj.cursor = 0;
         obj.status = 0; 
         /////// 硬件
         obj.R_Arr = 
         {
                     "R0":"",
                     "R1":"",
                     "R2":"",
                     "R3":"",
                     "R6":"",
                     "R7":"",
                     "R8":"",
                     "R9":"",
                     "R10":"",
                     "R11":"",
                     "R12":"",
                     "R13":"",
                     "R14":"",
                     "R15":""
         };
         obj.SP = [];
         obj.C = "0";   // 针对每一位的操作,当有进位时为1,没有进位的时候为0;
         obj.Z = "1";   // 一次计算当计算结果为0时,为1,否则为0;
         obj.screen = 0;
    }

    function keyDown(e) 
    {     
          var keycode; // 按键码
          var realkey; // 字符
          var edit_p = Get_CurrentScreenLine();            // 正在编辑的一行
          var current_tec = Get_CurrentTec();
          var status = current_tec.status;
          if (navigator.appName == "Microsoft Internet Explorer")//IE
          {
               keycode = event.keyCode;
               realkey = String.fromCharCode(event.keyCode);
          }
          else  // Firefox,Opera
          {
               keycode = e.which;
               realkey = String.fromCharCode(e.which);
          }

          if( status === 0 || status === 1 || status === 2)
          {
              // 1字母 2数字 3空格 4逗号  以及回车,退格 其余忽略 
                                                     // ASCII
                if(  (keycode > 47 && keycode <58 )  // 0:48 9:57
                   ||(keycode > 64 && keycode < 91)  // A:65 Z:90
                  )           
                {
                   AddCharToLastLine.call( current_tec, realkey );
                }
                else if( keycode == 32)// 空格:32
                {
                   AddCharToLastLine.call( current_tec, " " );
                   return false;
                }
                else if( keycode == 188)// 逗号:188
                {
                   AddCharToLastLine.call( current_tec, "," );
                }
                else if( keycode == 8) // 退格
                { 
                  if( status === 0 && edit_p.innerHTML.length > init_line_len ) // 在初始状态下需要剩余 >和空格
                  {  
                     RecCharAtLastLine.call( current_tec ,"");
                  }
                  else if( (status === 1 || status === 2)  && edit_p.innerHTML.length > command_line_len) //多了两个空格
                  {  
                     RecCharAtLastLine.call( current_tec ,"");
                  }
                  // else
                  // {
                  //   console.log("不可再删除了");
                  //   alert(edit_p.innerHTML.length);
                  // }
                  return false;   // 返回false 去除浏览器自带回退
                }
                else if( keycode == 13) //回车 >E 2000 将>去掉
                {                       //只需 ->解析并输出 
                   if( status === 0 )
                   {  
                      Parse_Init_Order.call( current_tec , edit_p.innerHTML.slice(init_line_len) );  // 将本行内容传入解析函数
                   }
                   else if( status === 1)
                   {
                      Parse_A_Line.call( current_tec , edit_p.innerHTML.slice(command_line_len) );
                   }
                   else if( status === 2)
                   {
                      Parse_E_Line.call( current_tec , edit_p.innerHTML.slice(command_line_len) );
                   }
                }
          }
          else if( status === 3 ) // G
          {
             PORT["80"] = keycode.toString(16);
             // 81 次高位设为1
             var t = Complete_Binary( Hex_To_Binary( PORT["81"] ) );// 0000 0000 0000 0000
             PORT["81"] = Binary_To_Hex( t.slice(0,1) + '1' + t.slice(2) );
          }
          else  if( status === 4) // U
          { 
             // U命令进行时 无法输入字符
          }
          else
          {
            alert(111);
          }

    }

    function Get_CurrentTec()
    {
        var tec;
        if( TEC1.screen == 1)
        {
          tec = TEC1;
        }
        else if (TEC2.screen == 1) 
        {
          tec = TEC2;
        }
        return tec;
    }

    function Get_CurrentScreenLine()
    {
        var now_screen;
        var line;
        if( TEC1.screen == 1)
        {
           now_screen = document.getElementById("console1");
        }
        else if (TEC2.screen == 1) 
        {
           now_screen = document.getElementById("console2");
        }
        var p = now_screen.getElementsByTagName('p');
        line = p[ p.length-1 ];
        return line;
    }

    function PrintScreenInfo(str)
    {
        
    }
    


    function Jump1()
    { 
      Level_Change = 1;
      if( status == 3 && FLAG == 1 && Level_Change > Level)
      { // 中断跳转
        alert( "跳转前"+cursor.toString(16) );
        Stack_Push( "$" + Level + "#" + cursor);
        cursor = parseInt("2404",16);
        alert( cursor.toString(16) );
        Level = Level_Change;
      }
    }
    function Jump2()
    {
      Level_Change = 2;
      if( status ==3 && FLAG == 1 && Level_Change > Level)
      {
        alert( "跳转前"+cursor.toString(16) );
        Stack_Push("$" + Level + "#" + cursor);
        cursor = parseInt("2408",16);
        alert( cursor.toString(16) );
        Level = Level_Change;
      }
    }
    function Jump3()
    {
      Level_Change = 3;
      if( status == 3 && FLAG == 1 && Level_Change > Level)
      {
         alert( "跳转前"+cursor.toString(16) );
         Stack_Push("$" + Level + "#" + cursor);
         cursor = parseInt("240C",16);
         alert( cursor.toString(16) );
         Level = Level_Change;
      }
    }
</script>
</html>